<!DOCTYPE HTML>
<html>
    <head>
        <style>
        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tabcontent.selected {
            display: block;
        }
        .error {
            border-color: red;
        }
        .network-settings-container {
            width: 50%;
        }
        </style>
        <title>SimUServe {{deviceName}} setup page</title>
    </head>
    <body>
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'networkSetup')">ConnectionSettings</button>
            <button class="tablinks" onclick="openTab(event, 'deviceSetup')">Device Settings</button>
            <button class="tablinks" onclick="openTab(event, 'deviceInfo')">Device Info</button>
        </div>
        <div id="networkSetup" class="tabcontent selected">
            <h1>Welcome to the SimUServe network setup</h1>
            <form action="javascript:void(0);">
                <div class="network-settings-container">
                    <div class="ssid-container">
                        <label for="ssid">SSID:</label>
                        <select id="ssid" name="ssid" onchange="ssidSelected(event)" >
                            <option value="PleaseSelect">Please select an SSID</option>
                        </select>
                    </div>
                    <div class="password-container">
                        <label for="password">Password:</label>
                        <input id="password" type="password">
                        <input type="checkbox" onclick="togglePasswordVisibility()">Show Password
                    </div>
                    <div class="advanced-settings">
                        <input id="toggleAdvancedNetworkSettings" type="checkbox" onclick="toggleAdvancedSettings()"><strong>Advanced settings</strong>
                        <br/>
                        <em>Note: we recommend setting a static IP address for this device.  This will make it easier to connect to diagnose any issues</em>
                        <div id="advanced-settings-controls" class="advanced-settings-controls">
                            <div class="ip-address-setting">
                                <label for="ip-address">IP Address:</label>
                                <input id="ipAddress" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="button-container">
                        <button class="save" onclick="saveNetworkSettings()">Save</button>
                        <button class="refesh-networks" onclick="refreshNetworks()">Refresh Networks</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="deviceSetup" class="tabcontent">
            <h1>Welcome to the SimUServe device setup</h1>
            <hr>
            <h2>SimUServe server connection</h2>
            <p>Configure the SimUServe server connection here.  You can select Auto to try and find a server, or
                enter the IP manually.
            </p>
            <div>
                <input id="manualServer" type="checkbox" name="manualServer" onclick="toggleManualEntry()">
                <label for="manualServer">Manually Enter Server</label>
            </div>
            <div>
                <label for="serverSddress">Server Address</label>
                <input id="serverAddress" name="serverAddress" class="text-input" disabled>
            </div>
            <div class="button-container">
                <button id="findServer" class="refesh-networks" onclick="findServer()">Find SimUServer</button>
                <button id="connectToServer" class="primary-button" onclick="connectToServer()">Connect to Server</button>
            </div>
        </div>
        <div id="deviceInfo" class="tabcontent">
            <h1>SimUServe Device Info</h1>
        </div>
        <script>
            var advancedSettingsCheckbox,
                ipAddressTextbox,
                ssidCombo,
                passwordTextbox,
                manualServerCheckBox;
            function sendRequest(url, method, body, successCallback, failureCallback) {
                var xhr = new XMLHttpRequest();
                xhr.open(method, url);
                xhr.setRequestHeader("Content-type",
                "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        switch(xhr.status){
                            case 200:
                            case 201:
                            case 202:
                                successCallback(xhr.responseText);
                                break;
                            default:
                                if(failureCallback) {
                                    failureCallback(xhr.responseText);
                                }
                        }
                    }
                };
                xhr.send(body);
            }
            function get(url, successCallback, failureCallback) {
                sendRequest(url, "GET", null,
                    successCallback, failureCallback);
            }
            function post(url, data, successCallback, failureCallback) {
                sendRequest(url, "POST", data,
                    successCallback, failureCallback);
            }
            function removeClass(element, className) {
                element.className = element.className.replace(className, "");
            }
            function addClass(element, className) {
                element.className += className;
            }
            function removeOptions(optionElementId, startingAt) {
                var select = document.getElementById(optionElementId);
                startingAt = startingAt ?? 0;
                while(select.options.length > startingAt) {
                    select.remove(startingAt);
                }
            }
            function addOption(optionElementId,
                optionDisplay, optionValue,
                defaultSelected, selected) {
                var select = document.getElementById(optionElementId);
                select.options[select.options.length] =
                    new Option(optionDisplay, optionValue,
                        defaultSelected, selected);
            }
            function addOptions(optionElementId, optionElements) {
                var i;
                for(i = 0; i < optionElements.length; i++) {
                    addOption(optionElementId,
                        optionElements[i].optionDisplay,
                        optionElements[i].optionValue,
                        optionElements[i].defaultSelected,
                        optionElements[i].selected);
                }
            }
            function validateIPaddress(ipAddress) {
                if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipAddress))
                {
                    return (true)
                }
                alert("You have entered an invalid IP address!")
                return (false)
            }
            function togglePasswordVisibility() {
                if (passwordTextbox.type === "password") {
                    passwordTextbox.type = "text";
                } else {
                    passwordTextbox.type = "password";
                }
            }
            function openTab(evt, tabToOpen) {
              var i;
              var tabcontent;
              var tablinks;
              tabcontent = document.getElementsByClassName("tabcontent");
              for (i = 0; i < tabcontent.length; i++) {
                removeClass(tabcontent[i], " selected");
              }
              tablinks = document.getElementsByClassName("tablinks");
              for (i = 0; i < tablinks.length; i++) {
                removeClass(tablinks[i], " active");
              }
              addClass(document.getElementById(tabToOpen), " selected");
              addClass(evt.currentTarget, " active");
            }
            function ssidSelected(event) {
                var ssidCombo = event.currentTarget;
                if(ssidCombo.value === "PleaseSelect") {
                    addClass(ssidCombo, " error");
                    return;
                }
                removeClass(ssidCombo, " error");
            }
            function saveNetworkSettings() {
                var params;
                
                if(ssidCombo.value === "PleaseSelect") {
                    addClass(ssidCombo, " error");
                    return;
                }

                if(passwordTextbox.value === "") {
                    addClass(passwordTextbox, " error");
                    return;
                }

                if(ipAddressTextbox.value !== "" && !validateIPaddress(ipAddressTextbox.value))
                {
                    addClass(ipAddressTextbox, " error");
                    return;
                }

                params = "ssid=" + ssidCombo.value +
                    "&networkkey=" + passwordText.value +
                    "&advancedSettings=false";

                post("/api/network", params, function(response) {
                    console.log("/api/network - saved network");
                },
                function(response) {
                    console.log("/api/network - network save FAILED!");
                });
            }
            function parseNetworksAndAddToOption(networks)
            {
                var i;
                    removeOptions("ssid", 1);
                    
                    networks.sort(function(a,b) {
                        return parseInt(b.signalStrength) - parseInt(a.signalStrength);
                    });

                    console.log(networks);
                   
                    for(i = 0; i < networks.length; i++)
                    {
                        var networkData = networks[i];
                        addOption("ssid", networkData.ssid +
                            " (" + networkData.signalStrength + "%)",
                            networkData.ssid);
                    }
            }
            /**
             * Get available networks
             **/
            function getAvailableNetworks() {
                get("/api/network/all", function(response) {
                    parseNetworksAndAddToOption(JSON.parse(response));
                });
            }
            /**
             * Refreshes the network list
             **/
            function refreshNetworks() {
                get("/api/network/all/refresh", function(response) {
                    parseNetworksAndAddToOption(JSON.parse(response));
                });
            }
            /**
             * Gets the device information for display
             **/
            function getDeviceInfo() {
                
            }
            /**
             * Get available networks
             **/
             function getSavedSettings() {
                get("/api/settings", function(response) {
                    
                });
            }
            function toggleManualEntry() {
                
                if(manualServerCheckBox.checked) {
                    document.getElementById("serverAddress").
                        removeAttribute("disabled");
                    document.getElementById("findServer").
                        setAttribute("disabled", "disabled");
                } else {
                    document.getElementById("findServer").
                        removeAttribute("disabled");
                    document.getElementById("serverAddress").
                        setAttribute("disabled", "disabled");
                }
            }
            function pageInit() {
                // init control vars
                ssidCombo = document.getElementById("ssid");
                passwordTextbox = document.getElementById("password");
                ipAddressTextbox = document.getElementById("ipAddress");
                advancedSettingsCheckbox = document.getElementById("toggleAdvancedNetworkSettings");
                manualServerCheckBox = document.getElementById("manualServer");

                getAvailableNetworks();
                // get saved settings

                
            };

            if (document.readyState === "complete" ||
                (document.readyState !== "loading" && !document.documentElement.doScroll)) {
                pageInit();
            } else {
                document.addEventListener("DOMContentLoaded", pageInit);
            }
        </script>
    </body>
</html>